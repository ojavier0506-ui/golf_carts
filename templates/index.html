<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunCart Tracker</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js'></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .cart { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
        textarea { width: 100%; height: 40px; }

        /* Barra fija de resumen */
        .fixed-summary {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f4f4f4;
            padding: 10px 20px;
            border-bottom: 2px solid #ccc;
            z-index: 1000;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .fixed-summary h2 { margin: 0; font-size: 1.2em; }
        .status-item { background-color: orange; color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; }

        .save-btn { background-color: green; color: white; border-radius: 8px; padding: 8px 16px; border: none; cursor: pointer; }
        .history-btn { background-color: skyblue; color: white; border-radius: 8px; padding: 8px 16px; border: none; cursor: pointer; }

        #historyPanel { display: none; margin-top: 120px; }
        #calendar { max-width: 900px; margin-top: 20px; }
        #historyResult { background:#eee; padding:10px; margin-top:10px; white-space: pre-wrap; }
        body { margin-top: 120px; }
    </style>
</head>
<body>
    <h1>SunCart Tracker</h1>

    <!-- Barra de resumen fija -->
    <div class="fixed-summary">
        <h2>Status Summary:</h2>
        {% for status, count in counts.items() %}
            <div class="status-item" onclick="alertStatus('{{status}}')">{{status}}: {{count}}</div>
        {% endfor %}
        <button class="save-btn" onclick="saveChanges()">SAVE</button>
        <button class="history-btn" onclick="toggleHistory()">History</button>
    </div>

    <form id="cartForm">
        {% for cart in carts %}
            <div class="cart">
                <h3>{{cart}}</h3>
                <label>Status: </label>
                <select name="status_{{cart}}">
                    {% for option in status_options %}
                        <option value="{{option}}" {% if cart_states[cart]['status'] == option %}selected{% endif %}>{{option}}</option>
                    {% endfor %}
                </select>
                <br><br>
                <label>Comment:</label><br>
                <textarea name="comment_{{cart}}">{{cart_states[cart]['comment']}}</textarea>
            </div>
        {% endfor %}
    </form>

    <!-- Panel de historial -->
    <div id="historyPanel">
        <label>Select SunCart:</label>
        <select id="historyCart" onchange="loadCalendar()">
            <option value="">--Select--</option>
            {% for cart in carts %}
                <option value="{{cart}}">{{cart}}</option>
            {% endfor %}
        </select>
        <div id="calendar"></div>
        <pre id="historyResult"></pre>
    </div>

    <script>
        function alertStatus(status) {
            let carts = [];
            {% raw %}
            for (let cart of {{ carts | tojson }}) {
                let sel = document.querySelector('[name="status_' + cart + '"]');
                if(sel && sel.value === status) carts.push(cart);
            }
            {% endraw %}
            alert(`SunCarts ${status}: \n` + carts.join(", "));
        }

        function saveChanges() {
            let formData = new FormData(document.getElementById('cartForm'));
            fetch("/", {method: "POST", body: formData})
            .then(res => res.json())
            .then(data => alert(data.message));
        }

        function toggleHistory() {
            let panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        let calendar;
        function loadCalendar() {
            let cart = document.getElementById('historyCart').value;
            if (!cart) return;

            fetch('/get_cart_history_events', {
                method: 'POST',
                headers: {'Content-Type':'application/x-www-form-urlencoded'},
                body: 'cart=' + encodeURIComponent(cart)
            })
            .then(res => res.json())
            .then(events => {
                if (calendar) calendar.destroy();
                let calendarEl = document.getElementById('calendar');
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    events: events,
                    eventClick: function(info) {
                        let time = info.event.start.toISOString().replace("T", " ").substring(0,19);
                        let status = info.event.title;
                        let comment = info.event.extendedProps.comment;
                        document.getElementById('historyResult').textContent =
                            `Time: ${time}\nStatus: ${status}\nComment: ${comment}`;
                    }
                });
                calendar.render();
            });
        }
    </script>
</body>
</html>
