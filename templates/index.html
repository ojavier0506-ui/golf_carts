<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evermore SunCarts</title>
<link rel="icon" type="image/svg+xml" href="/static/spiral-main.svg">
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: url("/static/fondo.jpg") no-repeat center center fixed;
        background-size: cover;
        position: relative;
    }
    body::before {
        content: "";
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(6px);
        z-index: -1;
    }

    .fixed-summary {
        position: fixed; top: 0; left: 0; right: 0;
        background: #f4f4f4; padding: 10px 20px; border-bottom: 2px solid #ccc;
        z-index: 1000; display: flex; flex-wrap: wrap; 
        justify-content: flex-start; align-items: center; gap: 10px;
    }
    .fixed-summary h2 { margin: 0 10px 0 0; font-size: 1.2em; }

    .user-badge { margin-left: 10px; font-size: 0.9em; color: #333; }
    .status-item { 
        margin: 0 10px; font-size: 0.95em; 
        cursor: pointer; background-color: #ff9800; 
        color: white; padding: 5px 12px; border-radius: 12px; 
        font-weight: bold; transition: background-color 0.2s; 
    }
    .status-item:hover { background-color: #e68900; }

    body { margin-top: 160px; }
    @media (max-width: 768px) {
        body { margin-top: 220px; }
    }

    .container { 
        max-width: 420px; margin: auto; 
        border: 1px solid #ccc; padding: 20px; 
        border-radius: 8px; background: rgba(249, 249, 249, 0.9); 
    }
    label { display: block; margin-top: 10px; }
    select, textarea, button { width: 100%; margin-top: 5px; padding: 8px; }
    textarea { resize: vertical; }

    .muted { color: #555; font-size: 0.9em; margin-top: 8px; }

    .button-group {
        display: flex; gap: 10px; margin-left: auto; align-items: center;
    }
    .btn {
        padding: 8px 16px; border-radius: 6px; border: none;
        font-weight: bold; cursor: pointer; color: white;
        transition: background-color 0.2s;
    }
    .btn.save { background-color: #28a745; }
    .btn.save:hover { background-color: #218838; }
    .btn.logout { background-color: #dc3545; }
    .btn.logout:hover { background-color: #b02a37; }
    .btn.history { background-color: #ff9800; }
    .btn.history:hover { background-color: #e68900; }
    .btn.report { background-color: #6f42c1; }
    .btn.report:hover { background-color: #59359c; }
    .btn.admin { background-color: #17a2b8; }
    .btn.admin:hover { background-color: #138496; }

    .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
    .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }

    #modal-list li { padding: 6px 8px; background: rgba(0,0,0,0.04); margin-bottom: 6px; border-radius: 6px; cursor: pointer; }
    #modal-list li:hover { background: rgba(0,0,0,0.08); }
</style>
</head>
<body>
<h1>Evermore SunCarts</h1>

<div class="fixed-summary">
    <h2>Status Summary:</h2>
    {% for status, count in counts.items() %}
        <div class="status-item" onclick="showCategory('{{status}}')">
            <strong>{{status}}</strong>: <span id="count-{{status}}">{{count}}</span>
        </div>
    {% endfor %}

    <span class="user-badge">Logged in as: <strong>{{ session.get('username') }}</strong> ({{ session.get('role') }})</span>

    <div class="button-group">
        <button class="btn save" onclick="saveCart()">SAVE</button>
        <button class="btn history" onclick="window.location.href='/history'">HISTORY</button>
        <button class="btn report" onclick="window.location.href='/report'">REPORT</button>
        {% if session.get('role') == 'admin' %}
        <button class="btn admin" onclick="window.location.href='/admin/users'">ADMIN</button>
        {% endif %}
        <button class="btn logout" onclick="window.location.href='/logout'">LOGOUT</button>
    </div>
</div>

<div class="container">
    <label for="cart">Select SunCart:</label>
    <select id="cart" onchange="loadCart()">
        {% for cart in carts %}
            <option value="{{cart}}">{{cart}}</option>
        {% endfor %}
    </select>

    <label for="status">Status:</label>
    <select id="status">
        {% for option in status_options %}
            <option value="{{option}}">{{option}}</option>
        {% endfor %}
    </select>

    <label for="comment">Comment:</label>
    <textarea id="comment"></textarea>

    <!-- ⬇ Aquí mostramos el último cambio -->
    <p id="last-change" class="muted">No changes yet.</p>
</div>

<!-- Modal para categorías -->
<div id="category-modal" class="modal">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <ul id="modal-list"></ul>
    <button onclick="closeModal()">Close</button>
  </div>
</div>

<script>
function loadCart() {
    const cart = document.getElementById("cart").value;
    fetch(`/cart/${encodeURIComponent(cart)}`)
    .then(res => res.json())
    .then(data => {
        document.getElementById("status").value = data.status || "Unassigned";
        document.getElementById("comment").value = data.comment || "";

        const p = document.getElementById("last-change");
        if (data.last_change && (data.last_change.user || data.last_change.date)) {
            const u = data.last_change.user || "Unknown";
            const d = data.last_change.date || "";
            const t = data.last_change.time || "";
            const ct = data.last_change.change_type || "Change";
            p.textContent = `Last change by ${u} on ${d}${t ? " at " + t : ""} (${ct}).`;
        } else {
            p.textContent = "No changes yet.";
        }
    });
}

function saveCart() {
    const cart = document.getElementById("cart").value;
    const status = document.getElementById("status").value;
    const comment = document.getElementById("comment").value;

    const formData = new FormData();
    formData.append("cart", cart);
    formData.append("status", status);
    formData.append("comment", comment);

    fetch("/update_cart", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            for (const [st, count] of Object.entries(data.counts)) {
                const el = document.getElementById(`count-${st}`);
                if (el) el.textContent = count;
            }
            // refrescar la info (incluye el último cambio)
            loadCart();
            alert("Changes saved!");
        } else {
            alert("Error saving changes!");
        }
    });
}

function showCategory(status) {
    fetch(`/category/${encodeURIComponent(status)}`)
    .then(res => res.json())
    .then(data => {
        document.getElementById("modal-title").innerText = `SunCarts ${status}:`;
        const list = document.getElementById("modal-list");
        list.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
            const li = document.createElement("li");
            li.textContent = "No carts in this category";
            list.appendChild(li);
        } else {
            data.forEach(item => {
                const li = document.createElement("li");
                li.innerHTML = `<strong>${item.cart}</strong> - ${item.comment || "(no comment)"}`;
                li.tabIndex = 0;
                li.onclick = () => selectCartFromModal(item.cart);
                li.onkeypress = (e) => { if (e.key === 'Enter' || e.key === ' ') selectCartFromModal(item.cart); };
                list.appendChild(li);
            });
        }

        document.getElementById("category-modal").style.display = "block";
    });
}

function selectCartFromModal(cartName) {
    const sel = document.getElementById("cart");
    sel.value = cartName;
    loadCart();
    closeModal();
}

function closeModal() {
    document.getElementById("category-modal").style.display = "none";
}

// Carga inicial del primer carrito
loadCart();
</script>
</body>
</html>
