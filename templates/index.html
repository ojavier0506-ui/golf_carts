<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Cart Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .cart { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
        textarea { width: 100%; height: 40px; }
        .fixed-summary {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f4f4f4;
            padding: 10px 20px;
            border-bottom: 2px solid #ccc;
            z-index: 1000;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .fixed-summary h2 { margin: 0; font-size: 1.2em; }
        .save-btn { background-color: green; color: white; border-radius: 8px; padding: 8px 16px; border: none; cursor: pointer; }
        .history-btn { background-color: deepskyblue; color: white; border-radius: 8px; padding: 8px 16px; border: none; cursor: pointer; }
        #message { color: green; font-weight: bold; margin-left: 20px; }
        body { margin-top: 120px; }
    </style>
</head>
<body>
    <div class="fixed-summary">
        <h2>Status Summary:</h2>
        {% for status, count in counts.items() %}
            <div class="status-item"><strong>{{status}}</strong>: {{count}}</div>
        {% endfor %}
        <button class="save-btn" onclick="saveChanges()">SAVE</button>
        <button class="history-btn" onclick="toggleHistory()">History</button>
        <span id="message"></span>
    </div>

    <form id="cartForm">
        {% for cart in carts %}
            <div class="cart">
                <h3>{{cart}}</h3>
                <label>Status: </label>
                <select name="status_{{cart}}">
                    {% for option in status_options %}
                        <option value="{{option}}" {% if cart_states[cart]['status'] == option %}selected{% endif %}>{{option}}</option>
                    {% endfor %}
                </select>
                <br><br>
                <label>Comment:</label><br>
                <textarea name="comment_{{cart}}">{{cart_states[cart]['comment']}}</textarea>
            </div>
        {% endfor %}
    </form>

    <div id="historySection" style="display:none; margin-top:20px;">
        <label>Select SunCart:</label>
        <select id="historyCart">
            {% for cart in carts %}
                <option value="{{cart}}">{{cart}}</option>
            {% endfor %}
        </select>
        <button onclick="searchHistory()">Search</button>
        <div id="historyResult" style="margin-top:20px; border:1px solid #ccc; padding:10px; border-radius:5px;"></div>
    </div>

    <script>
        function saveChanges() {
            const form = document.getElementById('cartForm');
            const formData = new FormData(form);

            fetch("/", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('message').innerText = data.message;
                setTimeout(() => { document.getElementById('message').innerText = ""; }, 2000);
            })
            .catch(error => alert("Error saving changes: " + error));
        }

        function toggleHistory() {
            const section = document.getElementById('historySection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function searchHistory() {
            const cart = document.getElementById('historyCart').value;
            fetch(`/history?cart=${cart}`)
            .then(response => response.json())
            .then(data => {
                if(data.history.length === 0){
                    document.getElementById('historyResult').innerText = "No Data";
                } else {
                    let text = "";
                    data.history.forEach(entry => {
                        text += `${entry.timestamp}: Status=${entry.status}, Comment=${entry.comment}\n`;
                    });
                    document.getElementById('historyResult').innerText = text;
                }
            })
            .catch(err => alert("Error fetching history: " + err));
        }
    </script>
</body>
</html>
