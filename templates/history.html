<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SunCarts History</title>
<link rel="icon" type="image/svg+xml" href="/static/spiral-main.svg">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body {
        font-family: Arial, sans-serif; margin: 20px;
        background: url("/static/fondo.jpg") no-repeat center center fixed;
        background-size: cover; position: relative;
    }
    body::before {
        content: ""; position: fixed; top:0; left:0; right:0; bottom:0;
        background-color: rgba(255,255,255,0.6); backdrop-filter: blur(6px);
        z-index: -1;
    }
    h1 { margin-top: 0; }
    .controls { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
    label { font-weight: bold; }
    select, input[type="date"] { padding: 6px 8px; }
    .btn {
        padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: #fff;
    }
    .btn-back { background: #007bff; }
    .btn-back:hover { background: #0056b3; }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(249,249,249,0.92); }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .empty-row td { text-align: center; color: #666; font-style: italic; }

    @media (max-width: 768px) { body { margin: 16px; } table { font-size: 14px; } }
</style>
</head>
<body>
<h1>SunCart History</h1>

<div class="controls">
    <label for="cart-select">Select Cart:</label>
    <select id="cart-select">
        {% for cart in carts %}
            <option value="{{cart}}">{{cart}}</option>
        {% endfor %}
    </select>

    <label for="date-select">Select Date:</label>
    <input type="date" id="date-select">

    <button class="btn btn-back" onclick="window.location.href='/'">Back</button>
</div>

<table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Time</th>
            <th>User</th>
            <th>Change Type</th>
            <th>Old Value</th>
            <th>New Value</th>
            <th>Comment</th>
        </tr>
    </thead>
    <tbody id="history-table"></tbody>
</table>

<script>
const cartSelect = document.getElementById('cart-select');
const dateSelect = document.getElementById('date-select');
const historyTable = document.getElementById('history-table');

function renderRows(rows){
    historyTable.innerHTML = '';
    if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.className = 'empty-row';
        tr.innerHTML = `<td colspan="7">No entries for the selected cart/date.</td>`;
        historyTable.appendChild(tr);
        return;
    }
    rows.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${entry.date || ''}</td>
            <td>${entry.time || ''}</td>
            <td>${entry.user || '-'}</td>
            <td>${entry.change_type || ''}</td>
            <td>${entry.old_value ?? ''}</td>
            <td>${entry.new_value ?? ''}</td>
            <td>${(entry.comment ?? '').toString().replace(/\n/g,'<br>')}</td>
        `;
        historyTable.appendChild(tr);
    });
}

function loadHistory() {
    const cart = cartSelect.value;
    const selectedDate = dateSelect.value;

    fetch(`/history/${encodeURIComponent(cart)}`)
    .then(res => res.json())
    .then(data => {
        const filtered = data.filter(e => !selectedDate || e.date === selectedDate);
        renderRows(filtered);
    })
    .catch(() => {
        renderRows([]);
    });
}

cartSelect.addEventListener('change', loadHistory);
dateSelect.addEventListener('change', loadHistory);
loadHistory();
</script>
</body>
</html>
